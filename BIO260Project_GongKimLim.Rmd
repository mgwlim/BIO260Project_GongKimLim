---
title: "Predicting 2016 Arrests in Chicago"
output: html_document
---
**David Yoohyeon Gong, Hanseul Kim, and Melody Lim**

* LINK TO DATASET: All the datasets we used will be at this [link](https://drive.google.com/folderview?id=0Bz5vCQobiwZXeXo1cXF6OGlGbGM&usp=sharing).
* LINK TO VIDEO: The video can be found on [youtube](https://youtu.be/LHpawt2pUTw).
* LINK TO GITHUB: The GitHub repository can be found at this [link](https://github.com/mgwlim/BIO260Project_GongKimLim).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Motivation
Today, crime is everywhere and it is being committed every day and night around us. Whether it is sexual harassment, shooting or theft, some crime is still taking place right now. Although we cannot prevent every crime that is being committed, we can certainly deploy resources that are available in a more efficient and accurate way. As data scientists, we are highly motivated and dedicated to contribute to society to improve the crime management based on given data and statistics. In particular, we want to focus on crimes in Chicago because it has a higher crime rate compared to most cities in the United States. We want to develop a statistical model to analyze the patterns of time, place, and the types of crimes that occurred, and utilize this model to predict what the probability of arrest will be so we can respond to criminal acts more effectively.

### Objectives
In this project, we want to answer the following questions:

* Are there time effects on the number of crimes that occur?
* Are there regional effects on the number of crimes that occur?
* What are the best predictors of criminals being arrested?
* Based on the data in previous years, what is the best model that predicts the probability of a criminal being arrested in 2016?

Our overall goal for this project is to build the most effective model that predicts the probability of being arrested and to improve crime management accordingly. We would like to learn what the probability of being arrested will be for 2016 based on records for previous years, and search for significant predictors such as time the crime occurred, location of the crime, type of crime, and distance from the police station. In addition, we will observe when and where the crime happens the most, so we can deploy police forces on the right spot at the right time for the future crime. The benefits of this project are being able to respond to crime quickly and effectively to increase the probability of a criminal being arrested, and thus promote public safety.

### Approach
We began the project by collecting the 2012-2015 Chicago crime data sets from the [City of Chicago Data Portal Website](https://data.cityofchicago.org/). Then we performed exploratory analyses to determine which types of crimes occurred the most and the percentage of criminals arrested for those crimes. From the analysis, we were also able to determine where the crimes occurred the most and the corresponding arrest rates. Furthermore, we looked at how the number of crimes changed over time (year, month, hour, and day)  and also explored the regional effects on the occurrence of crimes by using mapping techniques. Based on our exploratory analysis, we decided to use five statistical methods to predict the probability of criminals being arrested in 2016: stepwise selection based on AIC, the lasso, linear discriminant analysis, K-Nearest Neighbors, and classification tree.

```{r, include=FALSE}
library(MASS)
library(readr)
library(plyr)
library(dplyr)
library(tidyr)
library(knitr)
library(xtable)
library(ggplot2)
library(ggmap)
library(rgdal)
library(maptools)
gpclibPermit()
library(rgeos)
library(gridExtra)
library(caret)
library(tree)
library(glmnet)
```

```{r, message=F, warning=F, comment=F, echo = F}
#Loading data and Data wrangling

crime2011<-read_csv("Crimes_-_2011.csv")
crime2012<-read_csv("Crimes_-_2012.csv")
crime2013<-read_csv("Crimes_-_2013.csv")
crime2014<-read_csv("Crimes_-_2014.csv")
crime2015<-read_csv("Crimes_-_2015.csv")
crime2016<-read_csv("Crimes_-_2016.csv")
crime<-bind_rows(crime2011,crime2012,crime2013,crime2014,crime2015)

#data wrangling: fixing duplicate column names
names(crime)[1]<-"Casenumber1"
names(crime)[24]<-"Casenumber2"
names(crime)[2] <- "ID1"
names(crime)[23] <- "ID2"
crime$Casenumber2<-ifelse(is.na(crime$Casenumber2), crime$Casenumber1,crime$Casenumber2)
crime$ID1<-ifelse(is.na(crime$ID1),crime$ID2,crime$ID1)

#combined dataset
crime<-crime %>% select(-Casenumber1,-ID2)

#removing unnecessary files to save space
rm(crime2011)
rm(crime2012)
rm(crime2013)
rm(crime2014)
rm(crime2015)


#separating Date and Time
crimedata<- crime %>% 
  separate(Date, into = c("Date","Time","AMPM"), sep = " ") %>%
  separate(Time, into = c("Hour","Minute","Second"), sep = ":") %>%
  separate(Date, into = c("Month","Date","year"), sep = "/") %>% 
  select(-Year)
#adding 12 hours to indicate PM
names(crimedata)[4] <-"Year"
crimedata$Hour<-ifelse(crimedata$AMPM == "PM", as.numeric(crimedata$Hour) + 12, crimedata$Hour)

crimedata$Month<-as.numeric(crimedata$Month)
crimedata$Date<-as.numeric(crimedata$Date)
crimedata$Year<-as.numeric(crimedata$Year)
#want to match day of week to the specific date (e.g. is 1/1/2012 a Monday?)
noleap<-c(0,31,28,31,30,31,30,31,31,30,31,30)
leap<-c(0,31,29,31,30,31,30,31,31,30,31,30)
noleap_sum<-rep(1,12)
leap_sum<-rep(1,12)
day<-c("Fri", "Sat", "Sun", "Mon", "Tue", "Wed", "Thu")

for (i in 1:length(noleap)){
  noleap_sum[i] <- sum(noleap[1:i])
  leap_sum[i]<-sum(leap[1:i])
}

#filter out 2011 for consistency since it does not have location data
crimedata <- crimedata %>% 
  mutate(index = ifelse(Year ==2011, noleap_sum[Month]+Date, 
                        ifelse(Year == 2012, leap_sum[Month]+Date+365,
                               ifelse(Year == 2013, noleap_sum[Month]+Date+365+366,
                                      ifelse(Year == 2014, noleap_sum[Month]+Date+365+366+365,
                                             noleap_sum[Month]+Date+365+366+365+365))))) %>%
  mutate(Day = day[(index %% 7)+1]) %>% filter(!Year == 2011)
rm(crime)

#grouping primary types into 5 categories
crimedata$newtype <- ifelse(crimedata$`Primary Type` %in% c("ASSAULT", "BATTERY"), "ASSAULT/BATTERY", crimedata$`Primary Type`)
crimedata$newtype <- ifelse(crimedata$newtype %in% c("BURGLARY", "MOTOR VEHICLE THEFT", "ROBBERY", "THEFT"), "BURGLARY/ROBBERY/THEFT", crimedata$newtype)
crimedata$newtype <- ifelse(crimedata$newtype %in% c("NARCOTICS", "OTHER NARCOTIC VIOLATION"), "NARCOTICS", crimedata$newtype)
crimedata$newtype <- ifelse(crimedata$newtype %in% c("ASSAULT/BATTERY", "BURGLARY/ROBBERY/THEFT", "CRIMINAL DAMAGE", "NARCOTICS"), crimedata$newtype, "OTHERS")
#grouping nonviolent vs violent
crimedata$violent <- ifelse(crimedata$`Primary Type` %in% c("CRIM SEXUAL ASSAULT","OFFENSE INVOLVING CHILDREN","SEX OFFENSE","OTHER OFFENSE","BATTERY","HOMICIDE","ASSAULT","WEAPONS VIOLATION","ROBBERY","INTERFERENCE WITH PUBLIC OFFICER","KIDNAPPING","HUMAN TRAFFICKING"), 1, 0)

# grouping location description into 8 categories: street, residence, apartment, sidewalk, other, school, airport, parking lot
crimedata$locationtype <- ifelse(crimedata$`Location Description` %in% c("AIRPORT TERMINAL LOWER LEVEL - SECURE AREA","AIRPORT EXTERIOR - NON-SECURE AREA","AIRPORT TRANSPORTATION SYSTEM (ATS)","AIRPORT TERMINAL UPPER LEVEL - NON-SECURE AREA" ,"AIRPORT/AIRCRAFT","AIRPORT BUILDING NON-TERMINAL - NON-SECURE AREA","AIRPORT TERMINAL LOWER LEVEL - NON-SECURE AREA" ,"AIRPORT TERMINAL UPPER LEVEL - SECURE AREA","AIRPORT PARKING LOT","AIRPORT BUILDING NON-TERMINAL - SECURE AREA" ,"AIRPORT EXTERIOR - SECURE AREA","AIRPORT VENDING ESTABLISHMENT","AIRPORT TERMINAL MEZZANINE - NON-SECURE AREA", "AIRCRAFT"), "AIRPORT",crimedata$`Location Description`)
crimedata$locationtype <- ifelse(crimedata$locationtype %in% c("SCHOOL, PUBLIC, BUILDING","PUBLIC HIGH SCHOOL","SCHOOL YARD","SCHOOL, PRIVATE, GROUNDS","SCHOOL, PUBLIC, GROUNDS","SCHOOL, PRIVATE, BUILDING"), "SCHOOL", crimedata$locationtype)
crimedata$locationtype <- ifelse(crimedata$locationtype %in% c("RESIDENCE","RESIDENCE PORCH/HALLWAY","RESIDENCE-GARAGE","RESIDENTIAL YARD (FRONT/BACK)","DRIVEWAY - RESIDENTIAL"), "RESIDENCE", crimedata$locationtype)
crimedata$locationtype <- ifelse(crimedata$locationtype %in% c("PARKING LOT","CHA PARKING LOT","POLICE FACILITY/VEH PARKING LOT","PARKING LOT/GARAGE(NON.RESID.)","CHA PARKING LOT/GROUNDS"), "PARKINGLOT", crimedata$locationtype)
crimedata$locationtype <- ifelse(crimedata$locationtype %in% c("APARTMENT","CHA APARTMENT"), "APARTMENT", crimedata$locationtype)
crimedata$locationtype <- ifelse(crimedata$locationtype %in% c("STREET", "RESIDENCE", "APARTMENT", "PARKINGLOT", "SCHOOL", "AIRPORT", "SIDEWALK"), crimedata$locationtype, "OTHER")

```

## Descriptive Analysis

###1. Arrest
```{r, echo=FALSE}
#Descriptive analysis

#Arrest
table<-data.frame(table(crimedata$Arrest))
colnames(table) <- c("Arrest", "Number of Crimes")
table$Percentage <- table$"Number of Crimes" / sum(table$"Number of Crimes") * 100
kable(table)

```

The table shows that the overall percentage of arrests in Chicago is 73%. We want to build a model that successfully predicts the probability of arrest in order to help the Chicago police department improve their performance by further increasing the percentage of arrests.

###2. Crime Type
```{r, echo=FALSE, fig.height=5, fig.width=10}
##primary type 
#arrest - primary type
qplot(reorder(factor(`Primary Type`), factor(`Primary Type`), function(x) length(x)*-1), data=crimedata, geom="bar", fill=factor(Arrest)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + ylab("Number of Crimes") + xlab("Crime Types") + labs(fill="Arrest")

```

Looking at the figure above, we see that theft, battery, criminal damage, narcotics, and assault are the five most common types of crimes. Since our project focuses on the number of arrests, we observed whether certain crime types have a higher arrest rate. We see that although the police appear to effectively arrest criminals who illegally sell narcotics, they could further improve their performance in arresting criminals who are involved in other offenses such as theft, battery, and criminal damages.  

```{r, echo=FALSE, fig.height=4, fig.width=10}
#crime types in 5 categories
pt_count_fivecategory<-qplot(reorder(factor(newtype), factor(newtype), function(x) length(x)*-1), data=crimedata, geom="bar", fill=factor(Arrest)) + theme(axis.text.x = element_text(angle = 30, vjust = 0.5)) + ylab("Number of Crimes") + xlab("Crime Types") + labs(fill="Arrest")

#nonviolent vs violent
crimedata$violent <- ifelse(crimedata$`Primary Type` %in% c("CRIM SEXUAL ASSAULT","OFFENSE INVOLVING CHILDREN","SEX OFFENSE","OTHER OFFENSE","BATTERY","HOMICIDE","ASSAULT","WEAPONS VIOLATION","ROBBERY","INTERFERENCE WITH PUBLIC OFFICER","KIDNAPPING","HUMAN TRAFFICKING"), 1, 0)
pt_count_twocategory<-qplot(reorder(factor(violent), factor(violent), function(x) length(x)*-1), data=crimedata, geom="bar", fill=factor(Arrest)) + theme(axis.text.x = element_text(angle = 30, vjust = 0.5)) + ylab("Number of Crimes") + xlab("Crime Types") + labs(fill="Arrest") + scale_x_discrete(labels=c("NONVIOLENT","VIOLENT"))

grid.arrange(pt_count_fivecategory,pt_count_twocategory, ncol=2)

```

Since there are 33 types of crimes in the data set, we decided to organize them into 5 categories by similar characteristics: Burglary/Robbery/Theft, Assault/Battery, Criminal Damage, Narcotics, and Others. We also categorized the 33 types of crimes into non-violent vs. violent crimes. Here, we see that arrests for non-violent crimes seems to be slightly better compared to arrests for violent crimes. There appears to be a "crime type effect" on arrests since arrests seems to differ among different types of crimes, so we will include crime type in our prediction model.

###3. Location Type
```{r, echo=FALSE, fig.height=15, fig.width=10}
##location description
qplot(reorder(factor(`Location Description`), factor(`Location Description`), function(x) length(x)*1), data=crimedata, geom="bar", fill=factor(Arrest)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + ylab("Number of Crimes") + xlab("Location Types") + labs(fill="Arrest") + coord_flip()

```

Since the data set has 134 different location types, we decided to organize them into 8 categories by similar characteristics: Street, Residence, Apartment, Sidewalk, School, Airport, Parking Lots, and Other. 

```{r, echo=FALSE, fig.height=5}
#location types in 8 categories
qplot(reorder(factor(locationtype), factor(locationtype), function(x) length(x)*-1), data=crimedata, geom="bar", fill=factor(Arrest)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) + ylab("Number of Crimes") + xlab("Location Types") + labs(fill="Arrest")

```

Looking at the figure above, we notice that streets, residences, apartments, and sidewalks are the locations where crimes occur the most. We see a "location type effect" on arrests since arrests differ among different locations. For example, the probability of being arrested on sidewalks is higher than the probability of being arrested in apartments. Thus, we will include location type in our prediction model.

###4. Domestic vs. Non-domestic
```{r, echo=FALSE}
##domestic
table1<-data.frame(table(crimedata$Domestic, crimedata$Arrest))
colnames(table1) <- c("Domestic Crime","Arrest","Number of Crimes")
kable(table1)

```

We see that the total number of domestic crimes are 140189 + 35082 = 175271 and the total number of non-domestic crimes are 713573 + 287856 = 1001429. Among the domestic crimes, the percentage of arrest is $$\frac{35082}{175271}  = 0.20 * 100 = 20$$ and among the non-domestic crimes, the percentage of arrest is $$\frac{287856}{1001429} = 0.29 * 100 = 29$$. 

Thus, we could say that we see a "domestic effect" on arrest since the number of arrests differ between domestic vs. non-domestic crimes. So we are also going to include the binary domestic covariate in our prediction model. 

###5. Time Effect
We wanted to compare how the number of crimes and arrests change over the years, months, days, and hours. There is an overall significantly higher amount of crimes compared to arrests from 2012 to 2015, and both crimes and arrests appear to have decreasing trends over the years. Crimes appear to occur less frequently during the winter months (with the lowest number of crimes occurring in February) and occur more often during the summer months (with the highest number of crimes occurring in July). Both crimes and arrests occur the most on Fridays. However, the plot shows that the pattern of number of arrests throughout the week is consistent while the crimes are consistent from Monday to Thursday but greatly increase on Fridays. Crimes occur most frequently at 3 pm, 7 pm, and 12 am. The number of crimes significantly decreases between 1 to 5 am (which is when the lowest number of crimes occur) and then greatly increases after 5 am to 9 am. After 9 am, the crimes slightly fluctuate and then there is a sharp drop in crimes between 10 and 11 pm as well as an increase in crimes between 11 pm to 12 am. Arrests occur most frequently at 7 pm.
```{r, echo=FALSE, fig.height=7, fig.width=13, message=FALSE, warning=FALSE}
# crimes and arrests by year
crimeyear <- crimedata %>% 
  group_by(Year) %>% 
  summarize(crimes_year = n(), arrest_year = sum(Arrest == "true")) %>%
  ggplot(aes(Year)) + geom_point(aes(y=crimes_year)) + 
  geom_point(aes(y=arrest_year)) + geom_line(aes(y=crimes_year, colour = "crimes")) +
  geom_line(aes(y=arrest_year, colour="arrests")) + 
  ylab("number of occurrences") + 
  labs(title = "Crimes vs. Arrests by Year")+
  scale_colour_manual("",breaks=c("crimes", "arrests"), values = c("crimes" = "red", "arrests"="blue")) 

# crime and arrests by month
crimemonth <- crimedata %>% 
  group_by(Month) %>% 
  summarize(crimes_month = n(), arrest_month = sum(Arrest == "true")) %>% 
  ggplot(aes(Month)) + geom_point(aes(y=crimes_month)) +
  geom_point(aes(y=arrest_month)) +
  geom_line(aes(y=crimes_month, colour = "crimes")) +
  geom_line(aes(y=arrest_month, colour="arrests")) +
  ylab("number of occurrences") + labs(title = "Crimes vs. Arrests by Month") +
  scale_colour_manual("",breaks=c("crimes", "arrests"), values = c("crimes" = "red", "arrests"="blue")) + 
  scale_x_continuous(breaks=seq(1,12,1))

# reorder the day variable
crimedata$Day2 <- factor(crimedata$Day, levels = c("Mon", "Tue","Wed","Thu","Fri", "Sat","Sun"))

# crimes vs. arrests by day
crimeday <- crimedata %>% 
  group_by(Day2) %>% 
  summarize(crimes_day = n(), arrest_day = sum(Arrest == "true")) %>%
  ggplot(aes(Day2, group = 1)) + 
  geom_point(aes(y=crimes_day)) + 
  geom_point(aes(y=arrest_day)) + 
  geom_line(aes(y=crimes_day, colour = "crimes")) + 
  geom_line(aes(y=arrest_day, colour="arrests")) + 
  ylab("number of occurrences") + 
  labs(title = "Crimes vs. Arrests by Day")+
  scale_colour_manual("",breaks=c("crimes", "arrests"), values = c("crimes" = "red", "arrests"="blue")) 

# crimes vs. arrests by hour
crimehour <- crimedata %>% 
  group_by(Hour) %>% 
  summarize(crimes_hour = n(), arrest_hour = sum(Arrest == "true")) %>%
  ggplot(aes(Hour, group = 1)) + geom_point(aes(y=crimes_hour)) + 
  geom_point(aes(y=arrest_hour)) + 
  geom_line(aes(y=crimes_hour, colour = "crimes")) +
  geom_line(aes(y=arrest_hour, colour="arrests")) + 
  ylab("number of occurrences") + 
  labs(title = "Crimes vs. Arrests by Hour")+
  scale_colour_manual("",breaks=c("crimes", "arrests"), values = c("crimes" = "red", "arrests"="blue")) 


grid.arrange(crimeyear,crimemonth,crimeday,crimehour,ncol=2, nrow=2)
```

**Year Effects**

We are also interested in exploring whether there is a time effect on violent vs. non-violent crimes, domestic vs. non-domestic crimes, and different types of crimes such as burglaries, robberies, thefts, assaults, battery, narcotics, and criminal damages. In addition, we want to explore the time effects on crimes occuring in different locations such as apartments, residences, schools, streets, sidewalks, parking lots, and airports. The following plots show how the number of crime occurrences in different locations and crime types change over the years. There are many more non-violent crimes occurring compared to violent crimes as well as more non-domestic crimes occurring compared to domestic crimes. Burglaries, robberies and thefts appear to occur the most in Chicago compared to the other types of crimes. Excluding the "Other" location variable which includes over 100 categories, we see that the most crimes occur on the street and the least crimes occur in the airport.
```{r, echo=FALSE, fig.height=7, fig.width=13, message=FALSE, warning=FALSE}
# YEAR

# location type
p1 <- crimedata %>%
  group_by(Year) %>% 
  summarize(other_year = sum(locationtype == "OTHER"), apt_year = sum(locationtype == "APARTMENT"), res_year = sum(locationtype == "RESIDENCE"), sch_year = sum(locationtype == "SCHOOL"), str_year = sum(locationtype == "STREET"), side_year = sum(locationtype == "SIDEWALK"), park_year = sum(locationtype == "PARKINGLOT"), air_year = sum(locationtype == "AIRPORT")) %>%
  ggplot(aes(Year)) + geom_point(aes(y=other_year)) + geom_point(aes(y=apt_year)) + geom_point(aes(y=res_year)) + geom_point(aes(y=sch_year)) + geom_point(aes(y=str_year)) + geom_point(aes(y=side_year)) + geom_point(aes(y=park_year)) + geom_point(aes(y=air_year)) +
  geom_line(aes(y=other_year, colour = "other")) + geom_line(aes(y=apt_year, colour = "apartment")) + geom_line(aes(y=res_year, colour = "residence")) + geom_line(aes(y=sch_year, colour = "school")) + geom_line(aes(y=str_year, colour = "street")) + geom_line(aes(y=side_year, colour = "sidewalk")) + geom_line(aes(y=park_year, colour = "parkinglot")) + geom_line(aes(y=air_year, colour = "airport")) + ylab("number of occurrences") + labs(title = "Crimes Occurring in Location Types by Year") + 
  scale_color_manual("", breaks=c("other", "apartment", "residence", "school", "street", "sidewalk", "parkinglot", "airport"), values = c("other"="green", "apartment"="red", "residence"="blue", "school"="turquoise", "street"="orange", "sidewalk"="black", "parkinglot"="magenta", "airport" ="goldenrod"))

# domestic vs. non-domestic
p2 <- crimedata %>% 
  group_by(Year) %>% 
  summarize(dom_year = sum(Domestic == "true"), nodom_year = sum(Domestic == "false")) %>%
  ggplot(aes(Year)) + 
  geom_point(aes(y=dom_year)) + 
  geom_point(aes(y=nodom_year)) + 
  geom_line(aes(y=dom_year, colour = "domestic")) + 
  geom_line(aes(y=nodom_year, colour="non_domestic")) + 
  ylab("number of occurrences") + 
  labs(title = "Domestic vs. Non-Domestic Crimes by Year") +
  scale_colour_manual("",breaks=c("domestic", "non_domestic"), values = c("domestic" = "red", "non_domestic"="blue")) 

# create violent column
crimedata$violent <- ifelse(crimedata$`Primary Type` %in% c("CRIM SEXUAL ASSAULT","OFFENSE INVOLVING CHILDREN","SEX OFFENSE","OTHER OFFENSE","BATTERY","HOMICIDE","ASSAULT","WEAPONS VIOLATION","ROBBERY","INTERFERENCE WITH PUBLIC OFFICER","KIDNAPPING","HUMAN TRAFFICKING"), 1, 0)

# violent vs. non-violent
p3 <- crimedata %>% group_by(Year) %>% 
  summarize(violent_year = sum(violent==1), noviolent_year = sum(violent == 0)) %>%
  ggplot(aes(Year)) + 
  geom_point(aes(y=violent_year)) + 
  geom_point(aes(y=noviolent_year)) + 
  geom_line(aes(y=violent_year, colour = "violent")) +
  geom_line(aes(y=noviolent_year,colour="nonviolent")) + 
  ylab("number of occurrences") + 
  labs(title = "Violent vs. Non-violent Crimes by Year") +
  scale_colour_manual("",breaks=c("violent", "nonviolent"), values = c("violent" = "blue", "nonviolent"="red")) 

# types of crimes
p4 <- crimedata %>% 
  group_by(Year) %>%
  summarize(other_year = sum(newtype=="OTHERS"), crim_year = sum(newtype=="CRIMINAL DAMAGE"), steal_year = sum(newtype=="BURGLARY/ROBBERY/THEFT"), assault_year = sum(newtype=="ASSAULT/BATTERY"), nar_year = sum(newtype =="NARCOTICS")) %>% 
  ggplot(aes(Year)) + 
  geom_point(aes(y=other_year)) + 
  geom_point(aes(y=crim_year)) +
  geom_point(aes(y=steal_year)) +
  geom_point(aes(y=assault_year))+
  geom_point(aes(y=nar_year)) + 
  geom_line(aes(y=other_year, colour = "other")) +
  geom_line(aes(y=crim_year,colour="criminal_damage")) +
  geom_line(aes(y=steal_year,colour="burglary_robbery_theft")) +
  geom_line(aes(y=assault_year,colour="assault_battery")) +
  geom_line(aes(y=nar_year,colour="narcotics")) +
  ylab("number of occurrences") + 
  labs(title = "Types of Crimes by Year") +
  scale_colour_manual("",breaks=c("other", "criminal_damage", "burglary_robbery_theft", "assault_battery", "narcotics"), values = c("assault_battery" = "blue", "burglary_robbery_theft"="red", "criminal_damage" = "purple", "narcotics" = "orange", "other" = "green")) 

grid.arrange(p1,p2,p3,p4,ncol=2, nrow=2)
```

**Month Effects**

We will look at how these crime and location types change over the months. It appears that burglaries, robberies, and thefts are the crimes that occur the most in July, while assault and battery occur most frequently in May. The number of arrests appear to be consistent from January to October but decreases in November and December. There does not appear to be a month effect between violent and non-violent crimes since the changes in both the number of violent and non-violent crimes are similar. In addition, there does appear to be a month effect between domestic and non-domestic crimes since the pattern fluctuates for non-domestic crimes over the months while the pattern is consistent for domestic crimes over the months. Schools appear to have a lower number of crimes during the summer months between May and September. However, there seems to be an increase in crimes during the summer in streets, residences, and sidewalks. The number of crimes are consistent throughout the months for apartments, parking lots, and airports.
```{r, echo = FALSE, warning = FALSE, fig.height=7, fig.width=13}
# MONTH 

# location type
p5 <- crimedata %>%
  group_by(Month) %>% 
  summarize(other_month = sum(locationtype == "OTHER"), apt_month = sum(locationtype == "APARTMENT"), res_month = sum(locationtype == "RESIDENCE"), sch_month = sum(locationtype == "SCHOOL"), str_month = sum(locationtype == "STREET"), side_month = sum(locationtype == "SIDEWALK"), park_month = sum(locationtype == "PARKINGLOT"), air_month = sum(locationtype == "AIRPORT")) %>%
  ggplot(aes(Month)) + geom_point(aes(y=other_month)) + geom_point(aes(y=apt_month)) + geom_point(aes(y=res_month)) + geom_point(aes(y=sch_month)) + geom_point(aes(y=str_month)) + geom_point(aes(y=side_month)) + geom_point(aes(y=park_month)) + geom_point(aes(y=air_month))+
  geom_line(aes(y=other_month, colour = "other")) + geom_line(aes(y=apt_month, colour = "apartment")) + geom_line(aes(y=res_month, colour = "residence")) + geom_line(aes(y=sch_month, colour = "school")) + geom_line(aes(y=str_month, colour = "street")) + geom_line(aes(y=side_month, colour = "sidewalk")) + geom_line(aes(y=park_month, colour = "parkinglot")) + geom_line(aes(y=air_month, colour = "airport")) + ylab("number of occurrences") + labs(title = "Crimes Occurring in Location Types by Month") + 
  scale_color_manual("", breaks=c("other", "apartment", "residence", "school", "street", "sidewalk", "parkinglot", "airport"), values = c("other"="green", "apartment"="red", "residence"="blue", "school"="turquoise", "street"="orange", "sidewalk"="black", "parkinglot"="magenta", "airport" ="goldenrod")) + scale_x_continuous(breaks=seq(1,12,1))


# domestic vs. non-domestic
p6 <-crimedata %>% 
  group_by(Month) %>% 
  summarize(dom_month = sum(Domestic == "true"), nodom_month = sum(Domestic == "false")) %>% 
  ggplot(aes(Month)) + 
  geom_point(aes(y=dom_month)) + 
  geom_point(aes(y=nodom_month)) + 
  geom_line(aes(y=dom_month, colour = "domestic")) + 
  geom_line(aes(y=nodom_month, colour="non_domestic")) + 
  ylab("number of occurrences") + 
  labs(title = "Domestic vs. Non-Domestic Crimes by Month") +
  scale_colour_manual("",breaks=c("domestic", "non_domestic"), values = c("domestic" = "red", "non_domestic"="blue")) +
  scale_x_continuous(breaks=seq(1,12,1)) 

# violent vs. non-violent
p7 <- crimedata %>% 
  group_by(Month) %>%
  summarize(violent_month = sum(violent==1), noviolent_month = sum(violent == 0)) %>%
  ggplot(aes(Month)) + 
  geom_point(aes(y=violent_month)) + 
  geom_point(aes(y=noviolent_month)) + 
  geom_line(aes(y=violent_month, colour = "violent")) +
  geom_line(aes(y=noviolent_month, colour = "nonviolent")) + 
  ylab("number of occurrences") + 
  labs(title = "Violent vs. Non-violent Crimes by Month") +
  scale_x_continuous(breaks=seq(1,12,1)) + 
  scale_colour_manual("",breaks=c("violent", "nonviolent"), values = c("violent" = "blue", "nonviolent"="red")) 

# types of crimes
p8 <- crimedata %>%
  group_by(Month) %>% 
  summarize(other_month = sum(newtype=="OTHERS"), crim_month =sum(newtype=="CRIMINAL DAMAGE"), steal_month = sum(newtype=="BURGLARY/ROBBERY/THEFT"), assault_month = sum(newtype=="ASSAULT/BATTERY"), nar_month = sum(newtype =="NARCOTICS")) %>%
  ggplot(aes(Month)) + geom_point(aes(y=other_month)) + 
  geom_point(aes(y=crim_month)) +
  geom_point(aes(y=steal_month)) + 
  geom_point(aes(y=assault_month)) +
  geom_point(aes(y=nar_month)) + 
  geom_line(aes(y=other_month, colour = "other")) + 
  geom_line(aes(y=crim_month,colour="criminal_damage")) + 
  geom_line(aes(y=steal_month,colour="burglary_robbery_theft")) + 
  geom_line(aes(y=assault_month,colour="assault_battery")) + 
  geom_line(aes(y=nar_month,colour="narcotics")) +
  ylab("number of occurrences") + 
  labs(title = "Types of Crimes by Month") +
  scale_colour_manual("",breaks=c("other", "criminal_damage", "burglary_robbery_theft", "assault_battery", "narcotics"), values = c("assault_battery" = "blue", "burglary_robbery_theft"="red", "criminal_damage" = "purple", "narcotics" = "orange", "other" = "green")) + 
  scale_x_continuous(breaks=seq(1,12,1))


grid.arrange(p5,p6,p7, p8,ncol=2, nrow=2)
```

**Day Effects**

We hypothesized that crimes could occur more often on certain days so we examined how the crime types and location types changed by days of the week. In particular, crimes such as burglaries, robberies, and thefts occur the most on Fridays, while assaults and batteries occur mostly on Sundays. Non-violent and non-domestic crimes also occur the most on Fridays while violent and domestic crimes occur the most on Sundays. Day does not appear to have a significant effect on locations since the patterns appear to be consistent for most of the locations. Since there is no school on the weekends, the number of crimes decrease in schools during the weekends.
```{r, echo = FALSE, warning = FALSE, fig.height=7, fig.width=13}
# DAY

# location type
p9 <- crimedata %>%
  group_by(Day2) %>% 
  summarize(other_day = sum(locationtype == "OTHER"), apt_day = sum(locationtype == "APARTMENT"), res_day = sum(locationtype == "RESIDENCE"), sch_day = sum(locationtype == "SCHOOL"), str_day = sum(locationtype == "STREET"), side_day = sum(locationtype == "SIDEWALK"), park_day = sum(locationtype == "PARKINGLOT"), air_day = sum(locationtype == "AIRPORT")) %>%
  ggplot(aes(Day2, group = 1)) + geom_point(aes(y=other_day)) + geom_point(aes(y=apt_day)) + geom_point(aes(y=res_day)) + geom_point(aes(y=sch_day)) + geom_point(aes(y=str_day)) + geom_point(aes(y=side_day)) + geom_point(aes(y=park_day)) + geom_point(aes(y=air_day))+
  geom_line(aes(y=other_day, colour = "other")) + geom_line(aes(y=apt_day, colour = "apartment")) + geom_line(aes(y=res_day, colour = "residence")) + geom_line(aes(y=sch_day, colour = "school")) + geom_line(aes(y=str_day, colour = "street")) + geom_line(aes(y=side_day, colour = "sidewalk")) + geom_line(aes(y=park_day, colour = "parkinglot")) + geom_line(aes(y=air_day, colour = "airport")) + ylab("number of occurrences") + labs(title = "Crimes Occurring in Location Types by Day") + 
  scale_color_manual("", breaks=c("other", "apartment", "residence", "school", "street", "sidewalk", "parkinglot", "airport"), values = c("other"="green", "apartment"="red", "residence"="blue", "school"="turquoise", "street"="orange", "sidewalk"="black", "parkinglot"="magenta", "airport" ="goldenrod"))

# domestic vs. non-domestic
p10 <- crimedata %>% 
  group_by(Day2) %>% 
  summarize(dom_day = sum(Domestic == "true"), nodom_day = sum(Domestic == "false")) %>% 
  ggplot(aes(Day2, group = 1)) + 
  geom_point(aes(y=dom_day)) +
  geom_point(aes(y=nodom_day)) + 
  geom_line(aes(y=dom_day, colour = "domestic")) +
  geom_line(aes(y=nodom_day, colour="non_domestic")) + 
  ylab("number of occurrences") + 
  labs(title = "Domestic vs. Non-Domestic Crimes by Day") +
  scale_colour_manual("",breaks=c("domestic", "non_domestic"), values = c("domestic" = "red", "non_domestic"="blue")) 

# violent vs. non-violent
p11 <- crimedata %>% 
  group_by(Day2) %>% 
  summarize(violent_day = sum(violent==1), noviolent_day = sum(violent == 0)) %>%
  ggplot(aes(Day2, group = 1)) +
  geom_point(aes(y=violent_day)) + 
  geom_point(aes(y=noviolent_day)) + 
  geom_line(aes(y=violent_day, colour = "violent")) +
  geom_line(aes(y=noviolent_day, colour = "nonviolent")) +
  ylab("number of occurrences") + 
  labs(title = "Violent vs. Non-violent Crimes by Day") + 
  scale_colour_manual("",breaks=c("violent", "nonviolent"), values = c("violent" = "blue", "nonviolent"="red")) 

# types of crimes
p12 <- crimedata %>% 
  group_by(Day2) %>%
  summarize(other_day = sum(newtype=="OTHERS"), crim_day = sum(newtype=="CRIMINAL DAMAGE"), steal_day = sum(newtype=="BURGLARY/ROBBERY/THEFT"), assault_day = sum(newtype=="ASSAULT/BATTERY"), nar_day = sum(newtype =="NARCOTICS")) %>% ggplot(aes(Day2, group = 1)) + 
  geom_point(aes(y=other_day)) + 
  geom_point(aes(y=crim_day)) +
  geom_point(aes(y=steal_day)) + 
  geom_point(aes(y=assault_day)) +
  geom_point(aes(y=nar_day)) +
  geom_line(aes(y=other_day, colour = "other")) +
  geom_line(aes(y=crim_day,colour="criminal_damage")) +
  geom_line(aes(y=steal_day,colour="burglary_robbery_theft")) +
  geom_line(aes(y=assault_day,colour="assault_battery")) +
  geom_line(aes(y=nar_day,colour="narcotics")) +
  ylab("number of occurrences") + 
  labs(title = "Types of Crimes by Day") +
  scale_colour_manual("",breaks=c("other", "criminal_damage", "burglary_robbery_theft", "assault_battery", "narcotics"), values = c("assault_battery" = "blue", "burglary_robbery_theft"="red", "criminal_damage" = "purple", "narcotics" = "orange", "other" = "green")) 

grid.arrange(p9,p10,p11, p12,ncol=2, nrow=2)
```


**Hour Effects**

The following plots show the hour effects on the crime and location types. There is an hour effect on domestic vs. non-domestic crimes since domestic crimes have a consistent pattern across the hours while the non-domestic crimes have a fluctuating pattern across hours. Violent crimes tend to occur more at night, while a similar number of non-violent crimes occur during both the afternoon and night. There appears to be a significant hour effect on the types of crimes (criminal damage, burglary/robbery/theft, assault/battery, narcotics, and other). Burglaries, robberies, and thefts occur most frequently at 12 am, assaults and battery most commonly occur at 3 pm, criminal damages occur mostly at 12 pm and 10 pm, and the illegal sale of narcotics occur mostly at 7 pm. There appears to be a significant hour effect on the crimes occurring in different locations. Streets have the most crimes occurring at 10 pm, residences and apartments have the most crimes occurring at 9 am and 12 am, and sidewalks have the most crimes occurring at 7 pm.

```{r, echo = FALSE, warning = FALSE, fig.height=7, fig.width=13}
# HOUR

# location type
p13 <-crimedata %>%
  group_by(Hour) %>% 
  summarize(other_hour = sum(locationtype == "OTHER"), apt_hour = sum(locationtype == "APARTMENT"), res_hour = sum(locationtype == "RESIDENCE"), sch_hour = sum(locationtype == "SCHOOL"), str_hour = sum(locationtype == "STREET"), side_hour = sum(locationtype == "SIDEWALK"), park_hour = sum(locationtype == "PARKINGLOT"), air_hour = sum(locationtype == "AIRPORT")) %>%
  ggplot(aes(Hour, group = 1)) + geom_point(aes(y=other_hour)) + geom_point(aes(y=apt_hour)) + geom_point(aes(y=res_hour)) + geom_point(aes(y=sch_hour)) + geom_point(aes(y=str_hour)) + geom_point(aes(y=side_hour)) + geom_point(aes(y=park_hour)) + geom_point(aes(y=air_hour))+
  geom_line(aes(y=other_hour, colour = "other")) + geom_line(aes(y=apt_hour, colour = "apartment")) + geom_line(aes(y=res_hour, colour = "residence")) + geom_line(aes(y=sch_hour, colour = "school")) + geom_line(aes(y=str_hour, colour = "street")) + geom_line(aes(y=side_hour, colour = "sidewalk")) + geom_line(aes(y=park_hour, colour = "parkinglot")) + geom_line(aes(y=air_hour, colour = "airport")) + ylab("number of occurrences") + labs(title = "Crimes Occurring in Location Types by Hour") + 
  scale_color_manual("", breaks=c("other", "apartment", "residence", "school", "street", "sidewalk", "parkinglot", "airport"), values = c("other"="green", "apartment"="red", "residence"="blue", "school"="turquoise", "street"="orange", "sidewalk"="black", "parkinglot"="magenta", "airport" ="goldenrod"))

# domestic vs. non-domestic
p14 <- crimedata %>%
  group_by(Hour) %>% 
  summarize(dom_hour = sum(Domestic == "true"), nodom_hour = sum(Domestic == "false")) %>%
  ggplot(aes(Hour, group = 1)) + 
  geom_point(aes(y=dom_hour)) + 
  geom_point(aes(y=nodom_hour)) +
  geom_line(aes(y=dom_hour, colour = "domestic")) + 
  geom_line(aes(y=nodom_hour, colour="non_domestic")) +
  ylab("number of occurrences") + 
  labs(title = "Domestic vs. Non-Domestic Crimes by Hour") +
  scale_colour_manual("",breaks=c("domestic", "non_domestic"), values = c("domestic" = "red", "non_domestic"="blue")) 

# violent vs. non-violent
p15 <- crimedata %>% 
  group_by(Hour) %>%
  summarize(violent_hour = sum(violent==1), noviolent_hour = sum(violent == 0)) %>%
  ggplot(aes(Hour, group = 1)) + 
  geom_point(aes(y=violent_hour)) +  
  geom_point(aes(y=noviolent_hour)) + 
  geom_line(aes(y=violent_hour, colour = "violent")) + 
  geom_line(aes(y=noviolent_hour, colour = "nonviolent")) +
  ylab("number of occurrences") +
  labs(title = "Violent vs. Non-violent Crimes by Hour") +
  scale_colour_manual("",breaks=c("violent", "nonviolent"), values = c("violent" = "blue", "nonviolent"="red")) 

# types of crimes
p16 <- crimedata %>% 
  group_by(Hour) %>%
  summarize(other_hour = sum(newtype=="OTHERS"), crim_hour =sum(newtype=="CRIMINAL DAMAGE"), steal_hour = sum(newtype=="BURGLARY/ROBBERY/THEFT"), assault_hour = sum(newtype=="ASSAULT/BATTERY"), nar_hour = sum(newtype =="NARCOTICS")) %>% 
  ggplot(aes(Hour, group = 1)) + 
  geom_point(aes(y=other_hour)) + 
  geom_point(aes(y=crim_hour)) +
  geom_point(aes(y=steal_hour)) +
  geom_point(aes(y=assault_hour)) +
  geom_point(aes(y=nar_hour)) +
  geom_line(aes(y=other_hour, colour = "other")) +
  geom_line(aes(y=crim_hour,colour="criminal_damage")) +
  geom_line(aes(y=steal_hour,colour="burglary_robbery_theft")) +
  geom_line(aes(y=assault_hour,colour="assault_battery")) +
  geom_line(aes(y=nar_hour,colour="narcotics")) +
  ylab("number of occurrences") + 
  labs(title = "Types of Crimes by Hour") +
  scale_colour_manual("",breaks=c("other", "criminal_damage", "burglary_robbery_theft", "assault_battery", "narcotics"), values = c("assault_battery" = "blue", "burglary_robbery_theft"="red", "criminal_damage" = "purple", "narcotics" = "orange", "other" = "green")) 

grid.arrange(p13,p14,p15, p16,ncol=2, nrow=2)
```

###6. Regional Effect
We are interested in seeing the location of the crimes and the types of crimes occurring in Chicago. Using Google Maps, we plotted 1,000 random crime points:
```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Mapping
unzip("Chicagoshape.zip")
ogrInfo(".", "geo_export_34b5f872-0327-45f0-9099-c87f1f2b8b83")
chicago <- readOGR(".", "geo_export_34b5f872-0327-45f0-9099-c87f1f2b8b83")
chicago <- spTransform(chicago, CRS("+proj=longlat +datum=WGS84"))

location <- unlist(geocode('4135 S Morgan St, Chicago, IL 60609'))+c(0,.02)

gmap <- get_map(location=location, zoom = 10, maptype = "terrain", source = "google", col="bw")

chicagomap <- ggmap(gmap)
chicagomap <- chicagomap + geom_polygon(data=chicago, aes(x=long, y=lat, group=group), color="red", alpha=0) + xlab("Longitude") + ylab("Latitude")
chicagomap <- chicagomap + coord_map()
chicagomap <- chicagomap + theme_bw()

test_crimedata <- sample_n(crimedata,1000)
chicagomap + geom_point(data=test_crimedata, aes(x=`Longitude`, y=`Latitude`))

```

We already see that 1,000 points cover most of the plot, which is not discernible. 

Thus, we decided to create choropleths for Chicago broken into 77 community areas: 
```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
#change column name for crimedata to match with shapefile
colnames(crimedata)[which(names(crimedata) == "Community Area")] <- "id"
#exclude outliers
crimedata <- crimedata %>% filter(id != 0)
#our data
library(dplyr) 
mydata <- crimedata %>% group_by(id) %>% mutate(counts = n()) %>% select(id, counts) %>% unique()
chicago.ch <- fortify(chicago, region="area_numbe")
#merge with coefficients and reorder
merge.shp.coef<-merge(chicago.ch, mydata, by="id", all.x=TRUE)
final.plot<-merge.shp.coef[order(merge.shp.coef$order), ] 
#plotting choropleth
centers <- ddply(final.plot, .(id), summarize, clat = mean(lat), clong = mean(long))
ggplot() + geom_polygon(data = final.plot,
                        aes(x = long, y = lat, 
                            group = group, 
                            fill = counts),
                        color = "black", size = 0.25) + 
  coord_map() + scale_fill_distiller(name="Number of Crimes") +
  xlab("Longitude") + ylab("Latitude") + theme(panel.background = element_blank()) + geom_text(data = centers, aes(x = clong, y = clat, label = id))

```

We do not see a coastal effect (in other words, community areas along Lake Michigan do not show different crime patterns compared to other areas). We can see that community area 25, which is Austin, has the most crime. According to [Chicago Magazine](http://www.chicagomag.com/Chicago-Magazine/The-312/July-2012/Austin-Chicagos-Deadliest-Neighborhood/), Austin is Chicago's largest community area by land and is known to be the most violent neighborhood, which is supported by our choropleth.

**By looking at yearly patterns for community areas:**
```{r, echo=FALSE, fig.height=4, fig.width=10}
#choropleth function
choropleth <- function(x,y){
  year <- crimedata %>% filter(Year == x)
  colnames(year)[which(names(year) == "Community Area")] <- "id"
  year <- year %>% filter(id != 0)
  mydata <- year %>% group_by(id) %>% mutate(counts = n()) %>% select(id, counts) %>% unique()
  chicago.ch <- fortify(chicago, region="area_numbe")
  merge.shp.coef<-merge(chicago.ch, mydata, by="id", all.x=TRUE)
  final.plot<-merge.shp.coef[order(merge.shp.coef$order), ] 
  ggplot() + geom_polygon(data = final.plot,
                          aes(x = long, y = lat, 
                              group = group, 
                              fill = counts),
                          color = "black", size = 0.25) + coord_map() + 
    scale_fill_distiller(name="Number of Crimes", palette = "OrRd") + xlab("Longitude") + ylab("Latitude") + theme(panel.background = element_blank()) + ggtitle(y)
}
#assigning numbers to 5 crime type categories
crimedata$newtype <- ifelse(crimedata$newtype == "ASSAULT/BATTERY", 1, crimedata$newtype)
crimedata$newtype <- ifelse(crimedata$newtype == "BURGLARY/ROBBERY/THEFT", 2, crimedata$newtype)
crimedata$newtype <- ifelse(crimedata$newtype == "CRIMINAL DAMAGE", 3, crimedata$newtype)
crimedata$newtype <- ifelse(crimedata$newtype == "NARCOTICS", 4, crimedata$newtype)
crimedata$newtype <- ifelse(crimedata$newtype == "OTHERS", 5, crimedata$newtype)
choropleth2 <- function(x,y){
  x=as.character(x)
  type <- crimedata %>% filter(newtype == x)
  colnames(type)[which(names(type) == "Community Area")] <- "id"
  type <- type %>% filter(id != 0)
  mydata <- type %>% group_by(id) %>% mutate(counts = n()) %>% select(id, counts) %>% unique()
  chicago.ch <- fortify(chicago, region="area_numbe")
  merge.shp.coef<-merge(chicago.ch, mydata, by="id", all.x=TRUE)
  final.plot<-merge.shp.coef[order(merge.shp.coef$order), ] 
  ggplot() + geom_polygon(data = final.plot,
                          aes(x = long, y = lat, 
                              group = group, 
                              fill = counts),
                          color = "black", size = 0.25) + 
    scale_fill_distiller(name="Number of Crimes", palette = "YlGn") +
    coord_map() + xlab("Longitude") + ylab("Latitude") + theme(panel.background = element_blank()) + ggtitle(y)
}

#year
y1<-choropleth(2012, "2012")
y2<-choropleth(2013, "2013")
y3<-choropleth(2014, "2014")
y4<-choropleth(2015, "2015")
grid.arrange(y1,y2, ncol=2)
grid.arrange(y3,y4, ncol=2)

```

We did not observe any significant differences in crimes occurring in community areas from 2012 to 2015. However, we still see that that community area 25, Austin, consistently has the most number of crimes from year to year.

**By looking at different crime categories for community areas:**
```{r, echo=FALSE, fig.height=4, fig.width=10}
#by type
t1<-choropleth2(1, "Assault/Battery")
t2<-choropleth2(2, "Burglary/Robbery/Theft")
t3<-choropleth2(3, "Criminal damage")
t4<-choropleth2(4, "Narcotics")
t5<-choropleth2(5, "Others")
grid.arrange(t1,t2, ncol=2)
grid.arrange(t3,t4, ncol=2)
grid.arrange(t5, ncol=2)

```

Again, we see that Austin has the most number of crimes for all five categories of crimes. For the burglary/robbery/theft category, we notice that community area 8, Near North Side, has high crime counts. For the narcotics category, we see that crimes related to narcotics mostly happen in Austin, and not as frequently in other places.

**Looking at arrest rate for community areas:**
```{r, echo=FALSE}
#Arrest rate
crimedata$Arresttrue <- ifelse(crimedata$Arrest == "true",1,0)
colnames(crimedata)[which(names(crimedata) == "Community Area")] <- "id"
crimedata <- crimedata %>% filter(id != 0)
mydata <- crimedata %>% group_by(id) %>% mutate(counts = n()) %>% mutate(Arrestsum = sum(Arresttrue)) %>% mutate(Arrestrate = Arrestsum/counts*100) %>% select(id, Arrestrate) %>% unique() %>% ungroup
mydata %>% arrange(Arrestrate) %>% rename(`Community Area` = `id`) %>% rename(`Arrest Rate (%)` = `Arrestrate`)  %>% head(n=7) %>% kable
chicago.ch <- fortify(chicago, region="area_numbe")
merge.shp.coef<-merge(chicago.ch, mydata, by="id", all.x=TRUE)
final.plot<-merge.shp.coef[order(merge.shp.coef$order), ] 
centers <- ddply(final.plot, .(id), summarize, clat = mean(lat), clong = mean(long))
ggplot() + geom_polygon(data = final.plot,
                          aes(x = long, y = lat, 
                              group = group, 
                              fill = Arrestrate),
                          color = "black", size = 0.25) + coord_map() + 
    scale_fill_distiller(name="Arrest Rate (%)", palette = "Greys") + xlab("Longitude") + ylab("Latitude") + theme(panel.background = element_blank()) + geom_text(data = centers, aes(x = clong, y = clat, label = id))

```

We observe that Austin has a pretty high arrest rate compared to other community areas. This is probably because Austin is already known to be a dangerous area, so it is possible that the police force responds to crimes in Austin faster compared to the other areas. From the table, we notice that areas such as Forest Glen, Lincoln Park, and Hyde Park have low arrest rates (these areas have pretty low crime counts). Thus, there should be more frequent police patrols in these areas to increase arrest rates. 

## Model Building
```{r, echo=FALSE}

###Make "Arrest" a binary variable that is either 1 or 0 for the logistic regression
crimedata$Arrest <- ifelse(crimedata$Arrest=="true", 1, 0)

### Calculate the Euclidean distance between the police station and the crime site
police <- read_csv("police_stations.csv")

police_lat <- police$Latitude
police_lon <- police$Longitude

Distance_Station <- rep(0, nrow(crimedata))
Index_Station <- rep(0, nrow(crimedata))

for(i in 1:nrow(crimedata)){
  distances<-sqrt((crimedata$Latitude[i]-police_lat)^2+(crimedata$Longitude[i]-police_lon)^2)
  min_dist<-min(distances)
  Distance_Station[i] <- min_dist
  Index_Station[i] <- ifelse(is.na(min_dist),NA, which(distances == min_dist))
}

crimedata<-cbind(crimedata,Distance_Station,Index_Station)

###Do the same wrangling for 2016 Dataset###
#separating Date and Time
crime2016<- crime2016 %>% 
  separate(Date, into = c("Date","Time","AMPM"), sep = " ") %>%
  separate(Time, into = c("Hour","Minute","Second"), sep = ":") %>%
  separate(Date, into = c("Month","Date","year"), sep = "/") %>% 
  select(-Year)
#adding 12 hours to indicate PM
names(crime2016)[5] <-"Year"
crime2016$Hour<-ifelse(crime2016$AMPM == "PM", as.numeric(crime2016$Hour) + 12, crime2016$Hour)

crime2016$Month<-as.numeric(crime2016$Month)
crime2016$Date<-as.numeric(crime2016$Date)
crime2016$Year<-as.numeric(crime2016$Year)
#want to match day of week to the specific date (e.g. is 1/1/2012 a Monday?)
day<-c("Thu","Fri", "Sat", "Sun", "Mon", "Tue", "Wed")

#our dataset
crime2016 <- crime2016 %>% 
  mutate(index = leap_sum[Month]+Date) %>%
  mutate(Day = day[(index %% 7)+1]) 

crime2016$Arrest <- ifelse(crime2016$Arrest=="true", 1, 0)

### Calculate the Euclidean distance between the police station and the crime site
Distance_Station <- rep(0, nrow(crime2016))
Index_Station <- rep(0, nrow(crime2016))

for(i in 1:nrow(crime2016)){
  distances<-sqrt((crime2016$Latitude[i]-police_lat)^2+(crime2016$Longitude[i]-police_lon)^2)
  min_dist<-min(distances)
  Distance_Station[i] <- min_dist
  Index_Station[i] <- ifelse(is.na(min_dist),NA, which(distances == min_dist))
}

crime2016<-cbind(crime2016,Distance_Station,Index_Station)

#grouping primary types into 5 categories
crime2016$newtype <- ifelse(crime2016$`Primary Type` %in% c("ASSAULT", "BATTERY"), "ASSAULT/BATTERY", crime2016$`Primary Type`)
crime2016$newtype <- ifelse(crime2016$newtype %in% c("BURGLARY", "MOTOR VEHICLE THEFT", "ROBBERY", "THEFT"), "BURGLARY/ROBBERY/THEFT", crime2016$newtype)
crime2016$newtype <- ifelse(crime2016$newtype %in% c("ASSAULT/BATTERY", "BURGLARY/ROBBERY/THEFT", "CRIMINAL DAMAGE", "NARCOTICS"), crime2016$newtype, "OTHERS")

#grouping non-violent and violent crimes
crime2016$violent <- ifelse(crime2016$`Primary Type` %in% c("CRIM SEXUAL ASSAULT","OFFENSE INVOLVING CHILDREN","SEX OFFENSE","OTHER OFFENSE","BATTERY","HOMICIDE","ASSAULT","WEAPONS VIOLATION","ROBBERY","INTERFERENCE WITH PUBLIC OFFICER","KIDNAPPING","HUMAN TRAFFICKING"), 1, 0)

# grouping location description into 8 categories street, residence, apartment, sidewalk, other, school, airport, parking lot
crime2016$locationtype <- ifelse(crime2016$`Location Description` %in% c("AIRPORT TERMINAL LOWER LEVEL - SECURE AREA","AIRPORT EXTERIOR - NON-SECURE AREA","AIRPORT TRANSPORTATION SYSTEM (ATS)","AIRPORT TERMINAL UPPER LEVEL - NON-SECURE AREA" ,"AIRPORT/AIRCRAFT","AIRPORT BUILDING NON-TERMINAL - NON-SECURE AREA","AIRPORT TERMINAL LOWER LEVEL - NON-SECURE AREA" ,"AIRPORT TERMINAL UPPER LEVEL - SECURE AREA","AIRPORT PARKING LOT","AIRPORT BUILDING NON-TERMINAL - SECURE AREA" ,"AIRPORT EXTERIOR - SECURE AREA","AIRPORT VENDING ESTABLISHMENT","AIRPORT TERMINAL MEZZANINE - NON-SECURE AREA", "AIRCRAFT"), "AIRPORT",crime2016$`Location Description`)
crime2016$locationtype <- ifelse(crime2016$locationtype %in% c("SCHOOL, PUBLIC, BUILDING","PUBLIC HIGH SCHOOL","SCHOOL YARD","SCHOOL, PRIVATE, GROUNDS","SCHOOL, PUBLIC, GROUNDS","SCHOOL, PRIVATE, BUILDING"), "SCHOOL", crime2016$locationtype)
crime2016$locationtype <- ifelse(crime2016$locationtype %in% c("RESIDENCE","RESIDENCE PORCH/HALLWAY","RESIDENCE-GARAGE","RESIDENTIAL YARD (FRONT/BACK)","DRIVEWAY - RESIDENTIAL"), "RESIDENCE", crime2016$locationtype)
crime2016$locationtype <- ifelse(crime2016$locationtype %in% c("PARKING LOT","CHA PARKING LOT","POLICE FACILITY/VEH PARKING LOT","PARKING LOT/GARAGE(NON.RESID.)","CHA PARKING LOT/GROUNDS"), "PARKINGLOT", crime2016$locationtype)
crime2016$locationtype <- ifelse(crime2016$locationtype %in% c("APARTMENT","CHA APARTMENT"), "APARTMENT", crime2016$locationtype)
crime2016$locationtype <- ifelse(crime2016$locationtype %in% c("STREET", "RESIDENCE", "APARTMENT", "PARKINGLOT", "SCHOOL", "AIRPORT", "SIDEWALK"), crime2016$locationtype, "OTHER")


### Omit all the rows with NA, and change variable names for convinience.
### Since 2016 dataset has only data for Jan-April, we also subset out train data.
### Change numerical variables to factors.
crimedata1<-na.omit(crimedata) %>% filter(Month %in% c(1,2,3,4))

set.seed(5)
crimedata1 <- sample_n(crimedata1,1000)

names(crimedata1)[which(names(crimedata1)=="Location Description")] <-"Location_Description"
names(crimedata1)[which(names(crimedata1)=="Primary Type")] <-"Primary_Type"
names(crimedata1)[which(names(crimedata1)=="id")] <-"Community_Area"
names(crimedata1)[which(names(crimedata1)=="X Coordinate")] <-"X.Coordinate"
names(crimedata1)[which(names(crimedata1)=="Y Coordinate")] <-"Y.Coordinate"
names(crime2016)[which(names(crime2016)=="Location Description")] <-"Location_Description"
names(crime2016)[which(names(crime2016)=="Primary Type")] <-"Primary_Type"
names(crime2016)[which(names(crime2016)=="Community Area")] <-"Community_Area"
names(crime2016)[which(names(crime2016)=="X Coordinate")] <-"X.Coordinate"
names(crime2016)[which(names(crime2016)=="Y Coordinate")] <-"Y.Coordinate"

crime2016<-na.omit(crime2016) %>% 
  filter(Primary_Type %in% unique(crimedata1$Primary_Type)) %>%
  filter(Location_Description %in% unique(crimedata1$Location_Description))%>%
  filter(Community_Area %in% unique(crimedata1$Community_Area))

crimedata1<-crimedata1 %>% 
            filter(Primary_Type %in% unique(crime2016$Primary_Type)) %>%
            filter(Location_Description %in% unique(crime2016$Location_Description)) %>%
            filter(Community_Area %in% unique(crime2016$Community_Area))

crimedata1$Month <-as.factor(crimedata1$Month)
crimedata1$Community_Area<-as.factor(crimedata1$Community_Area)
crimedata1$Hour<-as.factor(crimedata1$Hour)
crimedata1$Primary_Type<-as.factor(crimedata1$Primary_Type)
crimedata1$Domestic<-as.factor(crimedata1$Domestic)
crimedata1$Location_Description<-as.factor(crimedata1$Location_Description)
crimedata1$Index_Station<-as.factor(crimedata1$Index_Station)
crimedata1$Day<-as.factor(crimedata1$Day)
crimedata1$violent<-as.factor(crimedata1$violent)
crimedata1$newtype<-as.factor(crimedata1$newtype)
crimedata1$locationtype<-as.factor(crimedata1$locationtype)

crime2016$Month <-as.factor(crime2016$Month)
crime2016$Community_Area<-as.factor(crime2016$Community_Area)
crime2016$Hour<-as.factor(crime2016$Hour)
crime2016$Primary_Type<-as.factor(crime2016$Primary_Type)
crime2016$Domestic<-as.factor(crime2016$Domestic)
crime2016$Location_Description<-as.factor(crime2016$Location_Description)
crime2016$Index_Station<-as.factor(crime2016$Index_Station)
crime2016$Day<-as.factor(crime2016$Day)
crime2016$violent<-as.factor(crime2016$violent)

#assigning numbers to 5 crime type categories
crime2016$newtype <- ifelse(crime2016$newtype == "ASSAULT/BATTERY", 1, crime2016$newtype)
crime2016$newtype <- ifelse(crime2016$newtype == "BURGLARY/ROBBERY/THEFT", 2, crime2016$newtype)
crime2016$newtype <- ifelse(crime2016$newtype == "CRIMINAL DAMAGE", 3, crime2016$newtype)
crime2016$newtype <- ifelse(crime2016$newtype == "NARCOTICS", 4, crime2016$newtype)
crime2016$newtype <- ifelse(crime2016$newtype == "OTHERS", 5, crime2016$newtype)

crime2016$newtype<-as.factor(crime2016$newtype)
crime2016$locationtype<-as.factor(crime2016$locationtype)

```

Our goal is to predict the probability of a criminal being arrested in 2016. The training set is the Chicago crime data sets from 2012 to 2015 while the testing set is the 2016 Chicago crime data set. Among the variables in the data set, we believe that month, day, hour, year, primary types of crimes, domestic/non-domestic, location type, community area, violent/non-violent, district, crime types (5 categories), distance between the crime location and the nearest police station, and police station might be the important predictors of the probability of a criminal being arrested. We decided to include police stations in the model because each police station might show different performances in arresting criminals. In order to determine which method best predicts arrests in 2016, we use five different methods: stepwise selection based on AIC, the lasso, linear discriminant analysis, k-nearest neighbors, and classification tree.

###1. Stepwise selection based on AIC

For the variable selection process, we fit a generalized linear model (GLM) with all the variables of interest, and then perform a stepwise selection based on AIC. 


```{r, message=F, warning=F, include=FALSE}
output<-glm(as.factor(Arrest)~ Month + Day + Primary_Type +  Hour + Year + Domestic + Community_Area + District + Distance_Station + Index_Station + newtype + violent+locationtype, data = crimedata1, family = "binomial")

stepwise <- step(output)
summary(stepwise)

```

From the stepwise selection based on AIC, the model with primary types of crimes and location type is selected as the best model. Therefore, we fit a generalized linear model with those variables and calculate how well it predicts arrests in 2016. 


```{r, echo=FALSE, message=FALSE, warning=FALSE}
rm(output)
fit1<-glm(as.factor(Arrest)~ Primary_Type + locationtype, data = crimedata1, family = "binomial")

f_hat1 <- predict(fit1, newdata = crime2016, type = "response")
prediction1<- ifelse(f_hat1>0.5, 1, 0)

accuracy1<-mean(crime2016$Arrest == prediction1, na.rm = TRUE)

accuracy1

```

###2. The Lasso

As an alternative to the stepwise selection, we can fit a model containing all p predictors using a technique that regularizes or shrinks the coefficient estimates towards zero. For the shrinkage method, we can use either the ridge regression or the lasso method. Given that we have many predictors and ridge regression will always generate a model involving all the predictors unless you make the tuning parameter, $\lambda = \infty$, we decided to use the lasso instead to shrink the coefficient estimates towards zero.

```{r, echo=TRUE}
x.train<-model.matrix(as.factor(Arrest)~ Month + Day + Primary_Type + Hour + Year + Domestic + Community_Area + District + Distance_Station + Index_Station + newtype + violent + locationtype, data = crimedata1)[,-1]
y.train<-crimedata1$Arrest
x.test<-model.matrix(as.factor(Arrest)~ Month + Day + Primary_Type + Hour + Year + Domestic + Community_Area + District + Distance_Station + Index_Station + newtype + violent + locationtype, data = crime2016)[,-1]
y.test<-crime2016$Arrest
grid<-10^seq(10,-2,length=100)

lasso.mod<-glmnet(x.train,y.train,alpha=1,lambda=grid, family = "binomial")
plot(lasso.mod)

```

From the plot, we can see that some of the coefficients will be zeros, depending on the choice of the tuning parameter, $\lambda$. To choose the optimal $\lambda$, we compute the cross-validation error for each value of $\lambda$, and then select the one for which the cross-validation error is the smallest. 

```{r, echo=TRUE}
set.seed(1)
cv.out <-cv.glmnet(x.train, y.train, alpha = 1)
plot(cv.out)
bestlambda<-cv.out$lambda.min
bestlambda

```

With the optimal tuning parameter $\lambda$, we proceed to fit a lasso model, and see how well it predicts arrests in 2016. 

```{r, echo=FALSE}
f_hat2 <- predict(lasso.mod, s= bestlambda, newx = x.test, type = "response")
prediction2<- ifelse(f_hat2>0.5, 1, 0)

accuracy2<-mean(crime2016$Arrest == prediction2, na.rm = TRUE)

accuracy2

```

###3. Linear Discriminant Analysis (LDA)
Next, we want to look into classification techniques. There are two widely-used classifiers: linear discriminant analysis (LDA) and quadratic discriminant analysis (QDA). Although QDA is a more flexible classifier, we decided to do LDA instead of QDA. Because we have too many predictors, it would be impractical to plug in all the estimates for the covariance matrix for each class. The alternative solution to this problem is to use LDA where we assume that the correlation structure is the same for all classes. 

Let's fit a LDA model, and see how well it predicts arrests in 2016.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
lda.fit <-lda(as.factor(Arrest) ~ Month + Day + Primary_Type +  Hour + Year + Domestic + Community_Area + District + Distance_Station + Index_Station + violent + newtype +locationtype, data = crimedata1)
prediction3<-predict(lda.fit, crime2016)$class

accuracy3<-mean(crime2016$Arrest == prediction3, na.rm = TRUE)

accuracy3

```

###4. K-nearest neighbors

LDA and QDA are related to the Bayes approach, but we don't usually have the information about the conditional distribution of Y given X. The alternative approach to estimate such a conditional distribution is K-nearest neighbors (KNN), a non-parametric method that is similar to bin smoothing. 

To calculate the optimal K, we perform cross-validation first.

```{r, echo=TRUE}
set.seed(2)
control <- trainControl(method='cv', number=4, p = 0.5)
res <- train(as.factor(Arrest)~ Month + Day + Primary_Type  +  Hour + Year + Domestic + Community_Area + District + Distance_Station + Index_Station + violent + newtype +locationtype,
             data = crimedata1,
             method = "knn",
             trControl = control,
             tuneGrid=data.frame(k=seq(1,40,2)),
             metric="Accuracy")
res
plot(res)

```

Based on the cross-validation, the highest accuracy is achieved when K = 13. Thus, we fit the KNN model again with K = 13, and see how well the model predicts arrests in 2016.

```{r, echo=FALSE}
fit4 <- knn3(as.factor(Arrest)~ Month + Day + Primary_Type + Hour + Year + Domestic + Community_Area + District + Distance_Station + Index_Station +violent + newtype+locationtype, data=crimedata1, k=13)
f_hat4 <- predict(fit4, newdata = crime2016, type="prob")
prediction4<- ifelse(f_hat4[,2] >0.5, 1, 0)

accuracy4<-mean(crime2016$Arrest == prediction4, na.rm = TRUE)

accuracy4

```

###5. Classification Tree Method

We can also use the classification tree method to predict a qualitative response. To grow a classification tree, we start with a single node, and then find the binary distinction which provides the most information about the class. Then, for each of the new resulting nodes, we repeat the the same process until some stopping criterion is reached.

Let's now fit a classification tree model. Because the package restrains factor predictors to have 32 levels at most, we excluded the community area variable from the model.

```{r}
tree.crime<-tree(as.factor(Arrest)~ Month + Day + Primary_Type + Hour + Year + Domestic + District + Distance_Station + Index_Station + newtype + violent+locationtype, data = crimedata1)
summary(tree.crime)
```

According to the summary, the variables actually used in the tree construction are primary types of crime, location type, hour, and police station index. Let's see how well our tree predicts arrests in 2016.

```{r, echo=FALSE}
prediction5=predict(tree.crime ,crime2016 ,type="class")

accuracy5<-mean(crime2016$Arrest == prediction5, na.rm = TRUE)

accuracy5
```

The tree that we grew might be too complex and may overfit the data, which might lead to a worse prediction accuracy on the testing data set. Thus, we perform the cross-validation to determine the optimal level of tree complexity, and this process is called "pruning". Let's see how pruning the tree can improve the prediction accuracy.    

```{r, echo=TRUE}
set.seed(5)
cv.crime <- cv.tree(tree.crime)
cv.crime
plot(cv.crime$size ,cv.crime$dev ,type='b')
```

The "cv.crime" function provides the number of terminal nodes for each tree and the corresponding deviance, so we can see that the tree with two terminal nodes results in the lowest deviance. After pruning the tree, we can see the prediction accuracy is improved!

```{r, echo=FALSE}
prune.crime <- prune.tree(tree.crime, best = 2)
prediction5=predict(prune.crime, crime2016,type="class")

accuracy5<-mean(crime2016$Arrest == prediction5, na.rm = TRUE)

accuracy5

```

###6. Summary of all the methods

```{r, echo=FALSE}
Prediction_Accuracy <- data_frame(Method = "Stepwise (AIC)", Accuracy = accuracy1)

Prediction_Accuracy <- bind_rows(Prediction_Accuracy,
                                 data_frame(Method="Lasso",  
                                            Accuracy = accuracy2 ))
Prediction_Accuracy <- bind_rows(Prediction_Accuracy,
                                 data_frame(Method="LDA",  
                                            Accuracy = accuracy3 ))
Prediction_Accuracy <- bind_rows(Prediction_Accuracy,
                                 data_frame(Method="K-nearest neighbors",  
                                            Accuracy = accuracy4 ))
Prediction_Accuracy <- bind_rows(Prediction_Accuracy,
                                 data_frame(Method="Classification tree",  
                                            Accuracy = accuracy5))

Prediction_Accuracy %>% kable

```

Among the five models, the classification tree method after pruning results in the highest prediction accuracy. The lasso method shows slightly lower prediction accuracy than the classification tree method, and the stepwise selection based on AIC leads to lower prediction accuracy than the lasso method. The prediction accuracy of LDA is inferior to that of stepwise selection. Finally, the K-nearest neighbors shows the lowest prediction accuracy.

The reason why LDA underperforms compared to other methods might be that we assumed the true decision boundaries are linear (by making the covariance structure the same for all classes), but the assumption might be violated here due to non-linear decision boundaries.

Furthermore, both LDA and KNN methods might suffer from so-called "curse of dimensionality" -the performance of classifier decreases when the dimensionality of the problem becomes too large. Note also that the prediction accuracy of KNN might be inferior to that of LDA since KNN, among classifiers, is known to suffer the most from the curse of dimensionality. If we select fewer variables that are relevant, we might improve the prediction accuracy for both methods. Let's include primary types of crimes, hour, index of police station, and location type that are identified to be important in our classification tree, and see if the prediction accuracy improves. 

```{r, echo=FALSE}
lda.fit <-lda(as.factor(Arrest) ~ Primary_Type +  Hour +  + Index_Station +locationtype, data = crimedata1)
prediction3<-predict(lda.fit, crime2016)$class

accuracy3<-mean(crime2016$Arrest == prediction3, na.rm = TRUE)

cat("The prediction accuracy of LDA is", accuracy3)

set.seed(2)
control <- trainControl(method='cv', number=4, p = 0.5)
res <- train(as.factor(Arrest)~ Primary_Type +  Hour + Index_Station +locationtype,
             data = crimedata1,
             method = "knn",
             trControl = control,
             tuneGrid=data.frame(k=seq(1,40,2)),
             metric="Accuracy")
res
plot(res)

fit4 <- knn3(as.factor(Arrest)~ Primary_Type +  Hour + Index_Station +locationtype, data=crimedata1, k=13)
f_hat4 <- predict(fit4, newdata = crime2016, type="prob")
prediction4<- ifelse(f_hat4[,2] >0.5, 1, 0)

accuracy4<-mean(crime2016$Arrest == prediction4, na.rm = TRUE)

cat("The prediction accuracy of KNN is", accuracy4)
```

Including primary types of crimes, hour, index of police station, and location type in the LDA and KNN models improved each of the prediction accuracy by more than 2% and 1%, respectively.

```{r, echo=FALSE}
Prediction_Accuracy2 <- data_frame(Method = "Stepwise (AIC)", Accuracy = accuracy1)

Prediction_Accuracy2 <- bind_rows(Prediction_Accuracy2,
                                 data_frame(Method="Lasso",  
                                            Accuracy = accuracy2 ))

Prediction_Accuracy2 <- bind_rows(Prediction_Accuracy2,
                                 data_frame(Method="LDA",  
                                            Accuracy = accuracy3 ))

Prediction_Accuracy2 <- bind_rows(Prediction_Accuracy2,
                                 data_frame(Method="K-nearest neighbors",  
                                            Accuracy = accuracy4 ))

Prediction_Accuracy2 <- bind_rows(Prediction_Accuracy2,
                                 data_frame(Method="Classification tree",  
                                            Accuracy = accuracy5))

Prediction_Accuracy2 %>% kable

```

### Conclusion
Based on our analysis, we have reached the following conclusions:

* There should be more police patrols in areas with low arrest rates such as Forest Glen, Lincoln Park, and Hyde Park.
* The largest number of crimes appear to be occurring in the community area of Austin so there should be more efforts directed towards reducing crime in that area.
* The classification tree method should be used to predict arrests in the future, where the best predictors appear to be primary types of crimes, time (hour), index of police station, and location type.
